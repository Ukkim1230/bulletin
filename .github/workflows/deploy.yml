name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Build with Gradle
      run: |
        chmod +x gradlew
        ./gradlew clean build -x test --no-daemon -q
    
    - name: Locate JAR file
      id: jar
      run: |
        JAR=$(ls -1 build/libs/*SNAPSHOT*.jar 2>/dev/null | head -n1)
        if [ -z "$JAR" ]; then
          echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
          echo "build/libs ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          ls -la build/libs/ || echo "ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤"
          exit 1
        fi
        echo "jar=$JAR" >> $GITHUB_OUTPUT
        JAR_SIZE=$(du -h "$JAR" | cut -f1)
        echo "âœ… JAR íŒŒì¼ ë°œê²¬: $JAR ($JAR_SIZE)"
    
    - name: Verify EC2 connectivity
      env:
        HOST: ${{ secrets.EC2_HOST }}
      run: |
        echo "ğŸ” EC2 ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
        echo "ëŒ€ìƒ í˜¸ìŠ¤íŠ¸: $HOST"
        
        # í¬íŠ¸ 22 ì—°ê²° í…ŒìŠ¤íŠ¸
        timeout 5 bash -c "</dev/tcp/$HOST/22" 2>/dev/null && echo "âœ… í¬íŠ¸ 22 ì—´ë¦¼" || echo "âš ï¸ í¬íŠ¸ 22 ì—°ê²° ì‹¤íŒ¨"
        
        # ping í…ŒìŠ¤íŠ¸
        ping -c 2 $HOST 2>/dev/null && echo "âœ… Ping ì„±ê³µ" || echo "âš ï¸ Ping ì‹¤íŒ¨"
    
    - name: Copy files to EC2
      env:
        SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        HOST: ${{ secrets.EC2_HOST }}
        USERNAME: ${{ secrets.EC2_USERNAME }}
      run: |
        echo "$SSH_KEY" > /tmp/ec2_key.pem
        chmod 600 /tmp/ec2_key.pem
        
        SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30 -o ConnectionAttempts=5 -o ServerAliveInterval=10 -o ServerAliveCountMax=3 -v"
        
        # SSH ì—°ê²° í…ŒìŠ¤íŠ¸
        echo "ğŸ” SSH ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘..."
        ssh $SSH_OPTS -i /tmp/ec2_key.pem -o BatchMode=yes "$USERNAME@$HOST" "echo 'SSH ì—°ê²° ì„±ê³µ'" || {
          echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨!"
          echo "ë””ë²„ê¹… ì •ë³´:"
          echo "- í˜¸ìŠ¤íŠ¸: $HOST"
          echo "- ì‚¬ìš©ì: $USERNAME"
          echo "- SSH í‚¤ íŒŒì¼ ì¡´ì¬: $(test -f /tmp/ec2_key.pem && echo 'ì˜ˆ' || echo 'ì•„ë‹ˆì˜¤')"
          rm -f /tmp/ec2_key.pem
          exit 1
        }
        
        # JAR íŒŒì¼ ì „ì†¡ (ì¬ì‹œë„ ë¡œì§)
        echo "ğŸ“¦ JAR íŒŒì¼ ì „ì†¡ ì¤‘..."
        SSH_OPTS_SCP="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30 -o ConnectionAttempts=3"
        
        MAX_RETRIES=3
        RETRY_COUNT=0
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if scp $SSH_OPTS_SCP -i /tmp/ec2_key.pem \
            "${{ steps.jar.outputs.jar }}" \
            "$USERNAME@$HOST:/tmp/app.jar"; then
            echo "âœ… JAR íŒŒì¼ ì „ì†¡ ì„±ê³µ"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "âš ï¸ ì „ì†¡ ì‹¤íŒ¨ (ì‹œë„ $RETRY_COUNT/$MAX_RETRIES)"
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              sleep 5
            else
              echo "âŒ JAR íŒŒì¼ ì „ì†¡ ì‹¤íŒ¨ (ëª¨ë“  ì¬ì‹œë„ ì‹¤íŒ¨)"
              rm -f /tmp/ec2_key.pem
              exit 1
            fi
          fi
        done
        
        # ì„œë¹„ìŠ¤ íŒŒì¼ ì „ì†¡ (ì„ íƒì )
        if [ -f bulletin.service ]; then
          echo "ğŸ“¦ ì„œë¹„ìŠ¤ íŒŒì¼ ì „ì†¡ ì¤‘..."
          scp $SSH_OPTS_SCP -i /tmp/ec2_key.pem \
            bulletin.service \
            "$USERNAME@$HOST:/tmp/bulletin.service" || echo "âš ï¸ ì„œë¹„ìŠ¤ íŒŒì¼ ì „ì†¡ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰)"
        fi
        
        rm -f /tmp/ec2_key.pem
        echo "âœ… íŒŒì¼ ì „ì†¡ ì™„ë£Œ"
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 5m
        debug: false
        script: |-
          set -e
          
          # ìƒ‰ìƒ ì •ì˜
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          NC='\033[0m'
          
          APP_DIR="/opt/bulletin"
          SERVICE_NAME="bulletin"
          RUN_USER="${{ secrets.EC2_USERNAME }}"
          
          echo -e "${GREEN}ğŸš€ ë°°í¬ ì‹œì‘${NC}"
          
          # 1. ë””ë ‰í† ë¦¬ ìƒì„±
          sudo mkdir -p $APP_DIR/{logs,uploads/bulletin-images,uploads/sheet-music,uploads/small-groups}
          
          # 2. JAR íŒŒì¼ ì¡´ì¬ í™•ì¸ ë° ë³µì‚¬
          if [ ! -f /tmp/app.jar ]; then
            echo -e "${RED}âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: /tmp/app.jar${NC}"
            exit 1
          fi
          
          # ê¸°ì¡´ JAR ë°±ì—… (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
          if [ -f "$APP_DIR/app.jar" ]; then
            sudo cp "$APP_DIR/app.jar" "$APP_DIR/app.jar.backup.$(date +%s)"
            echo -e "${YELLOW}ğŸ“¦ ê¸°ì¡´ íŒŒì¼ ë°±ì—… ì™„ë£Œ${NC}"
          fi
          
          sudo cp /tmp/app.jar $APP_DIR/app.jar
          sudo chmod 644 $APP_DIR/app.jar
          echo -e "${GREEN}âœ… JAR íŒŒì¼ ë³µì‚¬ ì™„ë£Œ${NC}"
          
          # 3. ì „ì²´ ë””ë ‰í† ë¦¬ ì†Œìœ ê¶Œ ì„¤ì • (ì„œë¹„ìŠ¤ ì‹¤í–‰ ì‚¬ìš©ì)
          sudo chown -R $RUN_USER:$RUN_USER $APP_DIR
          echo -e "${GREEN}âœ… íŒŒì¼ ì†Œìœ ê¶Œ ì„¤ì • ì™„ë£Œ${NC}"
          
          # 4. .env íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸
          ENV_FILE="$APP_DIR/.env"
          sudo touch "$ENV_FILE"
          sudo chown $RUN_USER:$RUN_USER "$ENV_FILE"
          sudo chmod 600 "$ENV_FILE"
          
          # GitHub Secretsì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°)
          write_kv() {
            key="$1"
            val="$2"
            if [ -n "$val" ]; then
              if sudo grep -q "^$key=" "$ENV_FILE"; then
                sudo sed -i "s|^$key=.*|$key=$val|" "$ENV_FILE"
              else
                echo "$key=$val" | sudo tee -a "$ENV_FILE" > /dev/null
              fi
            fi
          }
          
          write_kv "DATABASE_URL" "${{ secrets.DATABASE_URL }}"
          write_kv "DB_USERNAME" "${{ secrets.DB_USERNAME }}"
          write_kv "DB_PASSWORD" "${{ secrets.DB_PASSWORD }}"
          write_kv "CLOUDINARY_CLOUD_NAME" "${{ secrets.CLOUDINARY_CLOUD_NAME }}"
          write_kv "CLOUDINARY_API_KEY" "${{ secrets.CLOUDINARY_API_KEY }}"
          write_kv "CLOUDINARY_API_SECRET" "${{ secrets.CLOUDINARY_API_SECRET }}"
          write_kv "PORT" "8080"
          
          # ê¸°ë³¸ê°’ ì„¤ì • (Secretsê°€ ì—†ì„ ê²½ìš°)
          if ! sudo grep -q "^DATABASE_URL=" "$ENV_FILE"; then
            echo "# ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •" | sudo tee -a "$ENV_FILE" > /dev/null
            echo "DATABASE_URL=jdbc:postgresql://localhost:5432/bulletin" | sudo tee -a "$ENV_FILE" > /dev/null
            echo "DB_USERNAME=postgres" | sudo tee -a "$ENV_FILE" > /dev/null
            echo "DB_PASSWORD=" | sudo tee -a "$ENV_FILE" > /dev/null
            echo "" | sudo tee -a "$ENV_FILE" > /dev/null
            echo "# Cloudinary ì„¤ì •" | sudo tee -a "$ENV_FILE" > /dev/null
            echo "CLOUDINARY_CLOUD_NAME=" | sudo tee -a "$ENV_FILE" > /dev/null
            echo "CLOUDINARY_API_KEY=" | sudo tee -a "$ENV_FILE" > /dev/null
            echo "CLOUDINARY_API_SECRET=" | sudo tee -a "$ENV_FILE" > /dev/null
          fi
          
          echo -e "${GREEN}âœ… .env íŒŒì¼ ì„¤ì • ì™„ë£Œ${NC}"
          
          # 5. ì„œë¹„ìŠ¤ íŒŒì¼ ì—…ë°ì´íŠ¸ (ì‚¬ìš©ì ë™ì  ì„¤ì •)
          if [ -f /tmp/bulletin.service ]; then
            # ì„œë¹„ìŠ¤ íŒŒì¼ì—ì„œ User/Groupì„ ë™ì ìœ¼ë¡œ ë³€ê²½
            sudo sed -i "s|^User=.*|User=$RUN_USER|" /tmp/bulletin.service
            sudo sed -i "s|^Group=.*|Group=$RUN_USER|" /tmp/bulletin.service
            sudo sed -i "s|/opt/bulletin/bulletin-0.0.1-SNAPSHOT.jar|/opt/bulletin/app.jar|" /tmp/bulletin.service
            sudo cp /tmp/bulletin.service /etc/systemd/system/bulletin.service
            sudo systemctl daemon-reload
            echo -e "${GREEN}âœ… ì„œë¹„ìŠ¤ íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ${NC}"
          else
            # ì„œë¹„ìŠ¤ íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒì„±
            if [ ! -f /etc/systemd/system/bulletin.service ]; then
              echo -e "${YELLOW}ğŸ“ ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì¤‘...${NC}"
              echo "[Unit]" | sudo tee /etc/systemd/system/bulletin.service > /dev/null
              echo "Description=êµíšŒ ëª¨ë°”ì¼ ì£¼ë³´ ì‹œìŠ¤í…œ" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "After=network-online.target" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "Wants=network-online.target" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "[Service]" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "Type=simple" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "User=$RUN_USER" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "Group=$RUN_USER" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "WorkingDirectory=$APP_DIR" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "EnvironmentFile=$APP_DIR/.env" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "Environment=\"SPRING_PROFILES_ACTIVE=ec2\"" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "ExecStart=/usr/bin/java -Xms512m -Xmx1024m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar $APP_DIR/app.jar" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "ExecStop=/bin/kill -15 \$MAINPID" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "Restart=on-failure" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "RestartSec=10" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "StartLimitInterval=60" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "StartLimitBurst=3" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "StandardOutput=journal" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "StandardError=journal" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "SyslogIdentifier=bulletin" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "# ë³´ì•ˆ ì„¤ì •" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "NoNewPrivileges=true" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "PrivateTmp=true" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "ProtectSystem=strict" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "ProtectHome=true" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "ReadWritePaths=$APP_DIR/uploads $APP_DIR/logs" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "# ë¦¬ì†ŒìŠ¤ ì œí•œ" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "LimitNOFILE=65536" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "LimitNPROC=4096" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "MemoryLimit=2G" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "[Install]" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              echo "WantedBy=multi-user.target" | sudo tee -a /etc/systemd/system/bulletin.service > /dev/null
              sudo systemctl daemon-reload
              echo -e "${GREEN}âœ… ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„± ì™„ë£Œ${NC}"
            fi
          fi
          
          # 6. ì„œë¹„ìŠ¤ ì¡´ì¬ í™•ì¸
          if [ ! -f /etc/systemd/system/bulletin.service ]; then
            echo -e "${RED}âŒ ì„œë¹„ìŠ¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤${NC}"
            exit 1
          fi
          
          # 7. ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì¬ì‹œì‘
          sudo systemctl enable $SERVICE_NAME 2>/dev/null || true
          echo -e "${YELLOW}ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘...${NC}"
          sudo systemctl restart $SERVICE_NAME
          
          # 8. ì„œë¹„ìŠ¤ ì‹œì‘ í™•ì¸ (ìµœëŒ€ 30ì´ˆ ëŒ€ê¸°)
          for i in {1..30}; do
            if sudo systemctl is-active --quiet $SERVICE_NAME; then
              echo -e "${GREEN}âœ… ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ (${i}ì´ˆ)${NC}"
              break
            fi
            if [ $i -eq 30 ]; then
              echo -e "${RED}âŒ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨ (íƒ€ì„ì•„ì›ƒ)${NC}"
              sudo journalctl -u $SERVICE_NAME -n 50 --no-pager
              exit 1
            fi
            sleep 1
          done
          
          # 9. ìµœì¢… ìƒíƒœ í™•ì¸
          echo -e "${GREEN}ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:${NC}"
          sudo systemctl status $SERVICE_NAME --no-pager | head -30
    
    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        debug: false
        script: |
          SERVICE_NAME="bulletin"
          
          if sudo systemctl is-active --quiet $SERVICE_NAME; then
            echo "âœ… ë°°í¬ ì„±ê³µ: ì„œë¹„ìŠ¤ê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
            echo ""
            echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
            sudo systemctl status $SERVICE_NAME --no-pager | head -15
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨: ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            echo ""
            echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸:"
            sudo journalctl -u $SERVICE_NAME -n 30 --no-pager
            exit 1
          fi
