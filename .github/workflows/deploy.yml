name: Deploy to AWS EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'
    
    - name: Build with Gradle
      run: |
        chmod +x gradlew
        ./gradlew clean build -x test --no-daemon -q
    
    - name: Verify JAR file
      run: |
        JAR_FILE="build/libs/bulletin-0.0.1-SNAPSHOT.jar"
        if [ ! -f "$JAR_FILE" ]; then
          echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
          exit 1
        fi
        JAR_SIZE=$(du -h "$JAR_FILE" | cut -f1)
        echo "âœ… JAR íŒŒì¼ í™•ì¸: $JAR_SIZE"
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 5m
        debug: false
        script: |-
          set -e
          
          # ìƒ‰ìƒ ì •ì˜
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          NC='\033[0m'
          
          APP_DIR="/opt/bulletin"
          JAR_FILE="bulletin-0.0.1-SNAPSHOT.jar"
          SERVICE_NAME="bulletin"
          
          echo -e "${GREEN}ğŸš€ ë°°í¬ ì‹œì‘${NC}"
          
          # 1. ë””ë ‰í† ë¦¬ ìƒì„±
          sudo mkdir -p $APP_DIR/{logs,uploads/bulletin-images,uploads/sheet-music,uploads/small-groups}
          
          # 2. JAR íŒŒì¼ ë°±ì—… ë° ë³µì‚¬
          if [ -f "$APP_DIR/$JAR_FILE" ]; then
            sudo cp "$APP_DIR/$JAR_FILE" "$APP_DIR/${JAR_FILE}.backup.$(date +%s)"
            echo -e "${YELLOW}ğŸ“¦ ê¸°ì¡´ íŒŒì¼ ë°±ì—… ì™„ë£Œ${NC}"
          fi
          
          sudo cp /tmp/$JAR_FILE $APP_DIR/$JAR_FILE
          sudo chown ec2-user:ec2-user $APP_DIR/$JAR_FILE
          sudo chmod 644 $APP_DIR/$JAR_FILE
          echo -e "${GREEN}âœ… JAR íŒŒì¼ ë³µì‚¬ ì™„ë£Œ${NC}"
          
          # 3. íŒŒì¼ ì†Œìœ ê¶Œ ì„¤ì •
          sudo chown -R ec2-user:ec2-user $APP_DIR/uploads $APP_DIR/logs 2>/dev/null || true
          
          # 4. .env íŒŒì¼ ì²˜ë¦¬
          if [ ! -f "$APP_DIR/.env" ]; then
            echo -e "${YELLOW}ğŸ“ .env íŒŒì¼ ìƒì„± ì¤‘...${NC}"
            cat << 'ENVEOF' | sudo tee $APP_DIR/.env > /dev/null
# ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
DATABASE_URL=jdbc:postgresql://localhost:5432/bulletin
DB_USERNAME=postgres
DB_PASSWORD=your_password_here

# Cloudinary ì„¤ì •
CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
PORT=8080
ENVEOF
            sudo chown ec2-user:ec2-user $APP_DIR/.env
            sudo chmod 600 $APP_DIR/.env
            echo -e "${GREEN}âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ (ìˆ˜ì • í•„ìš”!)${NC}"
          fi
          
          # 5. ì„œë¹„ìŠ¤ íŒŒì¼ ì—…ë°ì´íŠ¸ (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
          if [ -f /tmp/bulletin.service ]; then
            sudo cp /tmp/bulletin.service /etc/systemd/system/bulletin.service
            sudo systemctl daemon-reload
            echo -e "${GREEN}âœ… ì„œë¹„ìŠ¤ íŒŒì¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ${NC}"
          fi
          
          # 6. ì„œë¹„ìŠ¤ ì¡´ì¬ í™•ì¸
          if [ ! -f /etc/systemd/system/bulletin.service ]; then
            echo -e "${RED}âŒ ì„œë¹„ìŠ¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤${NC}"
            exit 1
          fi
          
          # 7. ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì¬ì‹œì‘
          sudo systemctl enable $SERVICE_NAME 2>/dev/null || true
          echo -e "${YELLOW}ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘...${NC}"
          sudo systemctl restart $SERVICE_NAME
          
          # 8. ì„œë¹„ìŠ¤ ì‹œì‘ í™•ì¸ (ìµœëŒ€ 30ì´ˆ ëŒ€ê¸°)
          for i in {1..30}; do
            if sudo systemctl is-active --quiet $SERVICE_NAME; then
              echo -e "${GREEN}âœ… ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ (${i}ì´ˆ)${NC}"
              break
            fi
            if [ $i -eq 30 ]; then
              echo -e "${RED}âŒ ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨ (íƒ€ì„ì•„ì›ƒ)${NC}"
              sudo journalctl -u $SERVICE_NAME -n 20 --no-pager
              exit 1
            fi
            sleep 1
          done
          
          # 9. ìµœì¢… ìƒíƒœ í™•ì¸
          echo -e "${GREEN}ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:${NC}"
          sudo systemctl status $SERVICE_NAME --no-pager | head -20
    
    - name: Copy JAR file
      run: |
        # SSH í‚¤ íŒŒì¼ ìƒì„±
        echo "${{ secrets.EC2_SSH_KEY }}" > /tmp/ec2_key.pem
        chmod 600 /tmp/ec2_key.pem
        
        # SSH ì˜µì…˜
        SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=10 -o ConnectionAttempts=3"
        
        # JAR íŒŒì¼ ì „ì†¡
        echo "ğŸ“¦ JAR íŒŒì¼ ì „ì†¡ ì¤‘..."
        scp $SSH_OPTS -i /tmp/ec2_key.pem \
          build/libs/bulletin-0.0.1-SNAPSHOT.jar \
          ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/tmp/ || {
          echo "âŒ JAR íŒŒì¼ ì „ì†¡ ì‹¤íŒ¨!"
          rm -f /tmp/ec2_key.pem
          exit 1
        }
        
        # ì„œë¹„ìŠ¤ íŒŒì¼ ì „ì†¡ (ì„ íƒì )
        if [ -f bulletin.service ]; then
          echo "ğŸ“¦ ì„œë¹„ìŠ¤ íŒŒì¼ ì „ì†¡ ì¤‘..."
          scp $SSH_OPTS -i /tmp/ec2_key.pem \
            bulletin.service \
            ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }}:/tmp/ || true
        fi
        
        rm -f /tmp/ec2_key.pem
        echo "âœ… íŒŒì¼ ì „ì†¡ ì™„ë£Œ"
    
    - name: Verify deployment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        port: 22
        timeout: 60s
        debug: false
        script: |
          SERVICE_NAME="bulletin"
          
          if sudo systemctl is-active --quiet $SERVICE_NAME; then
            echo "âœ… ë°°í¬ ì„±ê³µ: ì„œë¹„ìŠ¤ê°€ ì •ìƒ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤"
            echo ""
            echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
            sudo systemctl status $SERVICE_NAME --no-pager | head -15
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨: ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤"
            echo ""
            echo "ğŸ“‹ ìµœê·¼ ë¡œê·¸:"
            sudo journalctl -u $SERVICE_NAME -n 30 --no-pager
            exit 1
          fi
