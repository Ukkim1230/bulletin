<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title th:text="${sheetMusic.title} + ' - 주사랑교회 청년부'">악보 상세</title>
    
    <meta name="description" content="주사랑교회 청년부를 위한 모바일 주보 앱">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="/manifest.json">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- 공통 스타일 -->
    <th:block th:replace="~{fragments/styles :: styles}"></th:block>
</head>
<body>
    <!-- 헤더 -->
    <th:block th:replace="~{fragments/header :: header(${#temporals.createToday()})}"></th:block>

    <div class="container-fluid px-3 py-3">
        <!-- 뒤로가기 -->
        <div class="mb-3">
            <a href="/sheet-music" class="btn btn-sm" style="background: var(--secondary); border: 1px solid var(--border);">
                <i class="fas fa-arrow-left me-2"></i>목록으로
            </a>
        </div>

        <!-- 악보 상세 정보 -->
        <div class="section-card mb-4">
            <div class="card-body p-0">
                <!-- 악보 이미지 -->
                <div th:if="${sheetMusic.imageUrl}" 
                     style="width: 100%; height: 250px; background: var(--muted); position: relative; overflow: hidden;">
                    <img th:src="${sheetMusic.imageUrl}" 
                         th:alt="${sheetMusic.title}"
                         style="width: 100%; height: 100%; object-fit: cover;">
                </div>
                <div th:unless="${sheetMusic.imageUrl}" 
                     class="d-flex align-items-center justify-content-center"
                     style="width: 100%; height: 250px; background: var(--muted);">
                    <i class="fas fa-music fa-4x" style="color: var(--muted-foreground);"></i>
                </div>
                
                <!-- 정보 섹션 -->
                <div class="p-3">
                    <h3 class="fw-bold mb-2" th:text="${sheetMusic.title}">악보 제목</h3>
                    
                    <div class="d-flex gap-2 mb-3">
                        <span class="badge" 
                              th:style="${sheetMusic.difficulty.name() == 'EASY'} ? 'background: #22c55e; color: white;' : 
                                       (${sheetMusic.difficulty.name() == 'MEDIUM'} ? 'background: #f59e0b; color: white;' : 'background: #ef4444; color: white;')"
                              th:text="${sheetMusic.difficulty.displayName}">난이도</span>
                    </div>
                    
                    <table class="table table-borderless small mb-3">
                        <tr th:if="${sheetMusic.composer}">
                            <td class="fw-bold ps-0" style="width: 100px; color: var(--muted-foreground);">
                                <i class="fas fa-user me-2"></i>아티스트
                            </td>
                            <td th:text="${sheetMusic.composer}">아티스트</td>
                        </tr>
                        <tr th:if="${sheetMusic.songNumber}">
                            <td class="fw-bold ps-0" style="color: var(--muted-foreground);">
                                <i class="fas fa-hashtag me-2"></i>곡 번호
                            </td>
                            <td th:text="${sheetMusic.songNumber}">번호</td>
                        </tr>
                        <tr th:if="${sheetMusic.keySignature}">
                            <td class="fw-bold ps-0" style="color: var(--muted-foreground);">
                                <i class="fas fa-key me-2"></i>조성
                            </td>
                            <td th:text="${sheetMusic.keySignature}">조성</td>
                        </tr>
                        <tr th:if="${sheetMusic.tempo}">
                            <td class="fw-bold ps-0" style="color: var(--muted-foreground);">
                                <i class="fas fa-tachometer-alt me-2"></i>빠르기
                            </td>
                            <td th:text="${sheetMusic.tempo}">빠르기</td>
                        </tr>
                        <tr>
                            <td class="fw-bold ps-0" style="color: var(--muted-foreground);">
                                <i class="fas fa-calendar me-2"></i>등록일
                            </td>
                            <td th:text="${#temporals.format(sheetMusic.createdAt, 'yyyy-MM-dd HH:mm')}">등록일</td>
                        </tr>
                    </table>
                    
                    <!-- 액션 버튼들 -->
                    <div class="d-grid gap-2">
                        <div class="row g-2">
                            <div class="col-6" th:if="${sheetMusic.filePath}">
                                <a th:href="@{'/sheet-music/' + ${sheetMusic.id} + '/download'}" 
                                   class="btn w-100" 
                                   style="background: var(--primary); color: var(--primary-foreground);">
                                    <i class="fas fa-download me-2"></i>다운로드
                                </a>
                            </div>
                            <div class="col-6" th:if="${sheetMusic.filePath}">
                                <a th:href="@{'/sheet-music/' + ${sheetMusic.id} + '/view'}" 
                                   class="btn w-100" 
                                   style="background: var(--secondary); border: 1px solid var(--border);"
                                   target="_blank">
                                    <i class="fas fa-eye me-2"></i>미리보기
                                </a>
                            </div>
                            <div th:unless="${sheetMusic.filePath}" class="col-12">
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-exclamation-circle me-2"></i>악보 파일이 없습니다
                                </div>
                            </div>
                        </div>
                        <button class="btn w-100" 
                                th:classappend="${sheetMusic.isFavorite} ? 'btn-warning' : 'btn-outline-secondary'"
                                th:onclick="'toggleFavorite(' + ${sheetMusic.id} + ')'">
                            <i th:class="${sheetMusic.isFavorite} ? 'fas fa-star' : 'far fa-star'" class="me-2"></i>
                            <span th:text="${sheetMusic.isFavorite} ? '즐겨찾기 해제' : '즐겨찾기 추가'">즐겨찾기</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 관련 악보 -->
        <div th:if="${relatedMusic != null and !relatedMusic.isEmpty()}" class="mb-4">
            <h5 class="fw-bold mb-3">
                <i class="fas fa-list me-2"></i>다른 악보
            </h5>
            <div class="row g-2">
                <div th:each="music : ${relatedMusic}" class="col-6">
                    <div class="section-card h-100">
                        <div class="card-body p-2 text-center">
                            <div th:if="${music.imageUrl}" 
                                 style="width: 100%; height: 100px; border-radius: var(--radius); overflow: hidden; background: var(--muted); margin-bottom: 0.5rem;">
                                <img th:src="${music.imageUrl}" 
                                     th:alt="${music.title}"
                                     style="width: 100%; height: 100%; object-fit: cover;">
                            </div>
                            <div th:unless="${music.imageUrl}" 
                                 class="d-flex align-items-center justify-content-center"
                                 style="width: 100%; height: 100px; border-radius: var(--radius); background: var(--muted); margin-bottom: 0.5rem;">
                                <i class="fas fa-music fa-2x" style="color: var(--muted-foreground);"></i>
                            </div>
                            <h6 class="small fw-bold mb-2" th:text="${music.title}">제목</h6>
                            <a th:href="@{'/sheet-music/' + ${music.id}}" class="btn btn-sm w-100" 
                               style="background: var(--secondary); border: 1px solid var(--border);">
                                <i class="fas fa-eye me-1"></i>보기
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 하단 네비게이션 -->
    <th:block th:replace="~{fragments/bottom-nav :: bottom-nav}"></th:block>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <th:block th:replace="~{fragments/bottom-nav :: navigation-scripts}"></th:block>
    
    <script>
        // 페이지 로드 시 악보 탭 활성화
        document.addEventListener('DOMContentLoaded', function() {
            setActiveTab('music');
        });
        
        function toggleFavorite(id) {
            fetch('/api/sheet-music/' + id + '/favorite', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('즐겨찾기 설정에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('오류가 발생했습니다.');
            });
        }
    </script>
</body>
</html>