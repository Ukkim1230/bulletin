version: 0.2

# Amazon Linux 2/2023 í™˜ê²½ì—ì„œ ì‹¤í–‰
# CodeBuild ì´ë¯¸ì§€: aws/codebuild/amazonlinux2-x86_64-standard:7.0
# ë˜ëŠ”: aws/codebuild/amazonlinux2023-x86_64-standard:7.0

phases:
  pre_build:
    commands:
      - echo "ğŸ” ìš´ì˜ì²´ì œ í™•ì¸"
      - cat /etc/os-release
      - |
        # Java 17 ì„¤ì¹˜ (ì—†ëŠ” ê²½ìš°)
        if ! command -v java &> /dev/null || ! java -version 2>&1 | grep -q "17"; then
          echo "ğŸ“¦ Java 17 ì„¤ì¹˜ ì¤‘..."
          if [ -f /etc/os-release ] && grep -q "Amazon Linux" /etc/os-release; then
            # Amazon Linux 2
            sudo yum update -y
            sudo yum install -y java-17-amazon-corretto-devel
          elif [ -f /etc/os-release ] && grep -q "Ubuntu" /etc/os-release; then
            # Ubuntu
            sudo apt-get update -y
            sudo apt-get install -y openjdk-17-jdk
          else
            # ê¸°íƒ€ (Amazon Linux 2023 ë“±)
            sudo yum update -y
            sudo yum install -y java-17-amazon-corretto-devel || sudo dnf install -y java-17-amazon-corretto-devel
          fi
          echo "âœ… Java 17 ì„¤ì¹˜ ì™„ë£Œ"
        else
          echo "âœ… Java 17ì´ ì´ë¯¸ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤"
        fi
      - echo "ğŸ” Java ë²„ì „ í™•ì¸"
      - java -version
      - echo "ğŸ” JAVA_HOME ì„¤ì •"
      - export JAVA_HOME=$(readlink -f /usr/bin/java | sed "s:bin/java::")
      - echo "JAVA_HOME=$JAVA_HOME" >> env_vars.txt
      - echo "ğŸ” Gradle ë²„ì „ í™•ì¸"
      - ./gradlew --version
      
  build:
    commands:
      - echo "ğŸ”¨ Gradle ë¹Œë“œ ì‹œì‘..."
      - chmod +x ./gradlew
      - ./gradlew clean build -x test --no-daemon
      
  post_build:
    commands:
      - echo "âœ… ë¹Œë“œ ì™„ë£Œ"
      - echo "ğŸ“¦ JAR íŒŒì¼ í™•ì¸"
      - JAR_FILE=$(ls -1 build/libs/*SNAPSHOT*.jar | head -n1)
      - echo "JAR_FILE=$JAR_FILE" >> env_vars.txt
      - ls -lh $JAR_FILE
      - echo "íŒŒì¼ í¬ê¸°: $(du -h $JAR_FILE | cut -f1)"
      - |
        if [ -n "$EC2_HOST" ] && [ -n "$EC2_SSH_KEY" ]; then
          echo "ğŸš€ EC2 ë°°í¬ ì‹œì‘..."
          echo "$EC2_SSH_KEY" > /tmp/ec2_key.pem
          chmod 600 /tmp/ec2_key.pem
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=60"
          USERNAME="${EC2_USERNAME:-ec2-user}"
          scp $SSH_OPTS -i /tmp/ec2_key.pem "$JAR_FILE" "$USERNAME@$EC2_HOST:/tmp/app.jar" || { echo "âŒ íŒŒì¼ ì „ì†¡ ì‹¤íŒ¨"; rm -f /tmp/ec2_key.pem; exit 1; }
          ssh $SSH_OPTS -i /tmp/ec2_key.pem "$USERNAME@$EC2_HOST" "set -e && APP_DIR=\"/opt/bulletin\" && SERVICE_NAME=\"bulletin\" && RUN_USER=\"$USERNAME\" && sudo mkdir -p \$APP_DIR/{logs,uploads/bulletin-images,uploads/sheet-music,uploads/small-groups} && if [ -f \"\$APP_DIR/app.jar\" ]; then sudo cp \"\$APP_DIR/app.jar\" \"\$APP_DIR/app.jar.backup.\$(date +%s)\"; fi && sudo cp /tmp/app.jar \$APP_DIR/app.jar && sudo chown -R \$RUN_USER:\$RUN_USER \$APP_DIR && if [ -f /etc/systemd/system/\$SERVICE_NAME.service ]; then sudo systemctl restart \$SERVICE_NAME && echo \"âœ… ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ\"; fi && rm -f /tmp/app.jar"
          rm -f /tmp/ec2_key.pem
          echo "âœ… ë°°í¬ ì™„ë£Œ"
        else
          echo "âš ï¸ EC2 í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì•„í‹°íŒ©íŠ¸ë§Œ ìƒì„±í•©ë‹ˆë‹¤."
        fi

artifacts:
  files:
    - 'build/libs/*.jar'
    - 'bulletin.service'
    - 'env.template'
    - 'deploy-ec2.sh'
  name: bulletin-artifacts

