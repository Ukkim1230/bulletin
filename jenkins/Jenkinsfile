pipeline {
    agent any
    
    environment {
        // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        JAVA_HOME = 'C:\\work\\jdk-17.0.2'
        GRADLE_HOME = "${WORKSPACE}\\gradle"
        APP_NAME = 'youth-bulletin'
        DOCKER_IMAGE = "${APP_NAME}:${BUILD_NUMBER}"
        DEPLOY_PORT = '80'
    }
    
    tools {
        gradle 'Gradle-8.3'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì¤‘...'
                checkout scm
                
                // Git ì •ë³´ ì¶œë ¥
                script {
                    def gitCommit = sh(returnStdout: true, script: 'git rev-parse HEAD').trim()
                    def gitBranch = sh(returnStdout: true, script: 'git rev-parse --abbrev-ref HEAD').trim()
                    echo "Git Commit: ${gitCommit}"
                    echo "Git Branch: ${gitBranch}"
                }
            }
        }
        
        stage('Environment Setup') {
            steps {
                echo 'í™˜ê²½ ì„¤ì • ì¤‘...'
                script {
                    // Java ë²„ì „ í™•ì¸
                    sh 'java -version'
                    
                    // Gradle ë²„ì „ í™•ì¸
                    sh './gradlew --version'
                    
                    // í”„ë¡œì íŠ¸ ì •ë³´ ì¶œë ¥
                    echo "í”„ë¡œì íŠ¸: ì²­ë…„ë¶€ ëª¨ë°”ì¼ ì£¼ë³´ ì‹œìŠ¤í…œ"
                    echo "ë¹Œë“œ ë²ˆí˜¸: ${BUILD_NUMBER}"
                    echo "ì‘ì—… ê³µê°„: ${WORKSPACE}"
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'Gradle ë¹Œë“œ ì‹œì‘...'
                script {
                    try {
                        // Gradle ë¹Œë“œ ì‹¤í–‰
                        sh './gradlew clean build -x test'
                        echo 'âœ… ë¹Œë“œ ì„±ê³µ!'
                    } catch (Exception e) {
                        echo "âŒ ë¹Œë“œ ì‹¤íŒ¨: ${e.getMessage()}"
                        error "ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                    }
                }
            }
            
            post {
                success {
                    echo 'ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë³´ê´€ ì¤‘...'
                    archiveArtifacts artifacts: 'build/libs/*.jar', fingerprint: true
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...'
                script {
                    try {
                        sh './gradlew test'
                        echo 'âœ… í…ŒìŠ¤íŠ¸ í†µê³¼!'
                    } catch (Exception e) {
                        echo "âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${e.getMessage()}"
                        // í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œì—ë„ ë°°í¬ëŠ” ê³„ì† ì§„í–‰ (ì„ íƒì‚¬í•­)
                    }
                }
            }
            
            post {
                always {
                    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰
                    publishTestResults testResultsPattern: 'build/test-results/test/*.xml'
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: 'build/reports/tests/test',
                        reportFiles: 'index.html',
                        reportName: 'Test Report'
                    ])
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                echo 'Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘...'
                script {
                    try {
                        // Docker ì´ë¯¸ì§€ ë¹Œë“œ
                        sh "docker build -t ${DOCKER_IMAGE} ."
                        sh "docker tag ${DOCKER_IMAGE} ${APP_NAME}:latest"
                        echo "âœ… Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ: ${DOCKER_IMAGE}"
                    } catch (Exception e) {
                        echo "âŒ Docker ë¹Œë“œ ì‹¤íŒ¨: ${e.getMessage()}"
                        error "Docker ì´ë¯¸ì§€ ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                    }
                }
            }
        }
        
        stage('Stop Previous Container') {
            steps {
                echo 'ì´ì „ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘...'
                script {
                    try {
                        // ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
                        sh "docker stop ${APP_NAME} || true"
                        sh "docker rm ${APP_NAME} || true"
                        echo 'âœ… ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì™„ë£Œ'
                    } catch (Exception e) {
                        echo "âš ï¸ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ (ì •ìƒì ì¼ ìˆ˜ ìˆìŒ): ${e.getMessage()}"
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'ìƒˆ ì»¨í…Œì´ë„ˆ ë°°í¬ ì¤‘...'
                script {
                    try {
                        // ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                        sh """
                            docker run -d \\
                                --name ${APP_NAME} \\
                                --restart unless-stopped \\
                                -p ${DEPLOY_PORT}:80 \\
                                -e SPRING_PROFILES_ACTIVE=prod \\
                                ${APP_NAME}:latest
                        """
                        
                        // ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
                        sleep(time: 10, unit: 'SECONDS')
                        sh "docker ps | grep ${APP_NAME}"
                        
                        echo "âœ… ë°°í¬ ì™„ë£Œ! í¬íŠ¸ ${DEPLOY_PORT}ì—ì„œ ì„œë¹„ìŠ¤ ì¤‘"
                    } catch (Exception e) {
                        echo "âŒ ë°°í¬ ì‹¤íŒ¨: ${e.getMessage()}"
                        error "ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì¤‘...'
                script {
                    def maxRetries = 10
                    def retryCount = 0
                    def healthCheckPassed = false
                    
                    while (retryCount < maxRetries && !healthCheckPassed) {
                        try {
                            sleep(time: 5, unit: 'SECONDS')
                            
                            // í—¬ìŠ¤ì²´í¬ API í˜¸ì¶œ
                            def response = sh(
                                script: "curl -f http://localhost:${DEPLOY_PORT}/api/bulletin/today",
                                returnStatus: true
                            )
                            
                            if (response == 0) {
                                healthCheckPassed = true
                                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ! (ì‹œë„ ${retryCount + 1}/${maxRetries})"
                            } else {
                                retryCount++
                                echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (ì‹œë„ ${retryCount}/${maxRetries})"
                            }
                        } catch (Exception e) {
                            retryCount++
                            echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: ${e.getMessage()} (ì‹œë„ ${retryCount}/${maxRetries})"
                        }
                    }
                    
                    if (!healthCheckPassed) {
                        error "í—¬ìŠ¤ì²´í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì œëŒ€ë¡œ ì‹œì‘ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                    }
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                echo 'ì´ì „ Docker ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘...'
                script {
                    try {
                        // ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì œê±° (ë””ìŠ¤í¬ ê³µê°„ ì ˆì•½)
                        sh "docker image prune -f"
                        echo 'âœ… Docker ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ'
                    } catch (Exception e) {
                        echo "âš ï¸ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: ${e.getMessage()}"
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'íŒŒì´í”„ë¼ì¸ ì™„ë£Œ'
            
            // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë¦¬
            cleanWs(
                cleanWhenNotBuilt: false,
                deleteDirs: true,
                disableDeferredWipeout: true,
                notFailBuild: true
            )
        }
        
        success {
            echo """
            ğŸ‰ ë°°í¬ ì„±ê³µ!
            
            ğŸ“± ì ‘ì† ì£¼ì†Œ:
            - ë©”ì¸: http://localhost:${DEPLOY_PORT}/
            - ëª¨ë°”ì¼: http://localhost:${DEPLOY_PORT}/mobile
            - API: http://localhost:${DEPLOY_PORT}/swagger-ui.html
            
            ğŸ” ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸:
            docker ps | grep ${APP_NAME}
            
            ğŸ“‹ ë¡œê·¸ í™•ì¸:
            docker logs ${APP_NAME}
            """
            
            // ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
            // emailext (
            //     subject: "âœ… ì²­ë…„ë¶€ ì£¼ë³´ ë°°í¬ ì„±ê³µ - Build #${BUILD_NUMBER}",
            //     body: "ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì ‘ì† ì£¼ì†Œ: http://localhost:${DEPLOY_PORT}/mobile",
            //     to: "admin@church.com"
            // )
        }
        
        failure {
            echo """
            âŒ ë°°í¬ ì‹¤íŒ¨!
            
            ğŸ” ë¬¸ì œ í•´ê²°:
            1. ë¹Œë“œ ë¡œê·¸ í™•ì¸
            2. Docker ìƒíƒœ í™•ì¸: docker ps -a
            3. ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸ í™•ì¸: docker logs ${APP_NAME}
            """
            
            // ì‹¤íŒ¨ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
            // emailext (
            //     subject: "âŒ ì²­ë…„ë¶€ ì£¼ë³´ ë°°í¬ ì‹¤íŒ¨ - Build #${BUILD_NUMBER}",
            //     body: "ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. Jenkins ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.",
            //     to: "admin@church.com"
            // )
        }
        
        unstable {
            echo 'âš ï¸ ë¹Œë“œëŠ” ì„±ê³µí–ˆì§€ë§Œ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
        }
    }
}
