pipeline {
    agent any
    
    environment {
        // í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        JAVA_HOME = 'C:\\work\\jdk-17.0.2'
        GRADLE_HOME = "${WORKSPACE}\\gradle"
        APP_NAME = 'youth-bulletin'
        DEPLOY_PORT = '80'
        BUILD_DIR = "${WORKSPACE}\\build\\libs"
        APP_PID_FILE = "${WORKSPACE}\\app.pid"
    }
    
    tools {
        gradle 'Gradle-8.3'  // Jenkinsì—ì„œ Gradle ë„êµ¬ ì„¤ì • í•„ìš”
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ ì¤‘...'
                checkout scm
                
                // Git ì •ë³´ ì¶œë ¥ (Windows í™˜ê²½)
                script {
                    try {
                        def gitCommit = bat(returnStdout: true, script: '@git rev-parse HEAD').trim()
                        def gitBranch = bat(returnStdout: true, script: '@git rev-parse --abbrev-ref HEAD').trim()
                        echo "Git Commit: ${gitCommit}"
                        echo "Git Branch: ${gitBranch}"
                    } catch (Exception e) {
                        echo "Git ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${e.getMessage()}"
                    }
                }
            }
        }
        
        stage('Environment Setup') {
            steps {
                echo 'í™˜ê²½ ì„¤ì • ì¤‘...'
                script {
                    // Java ë²„ì „ í™•ì¸
                    bat '''
                        echo Java í™˜ê²½ í™•ì¸:
                        "%JAVA_HOME%\\bin\\java" -version
                    '''
                    
                    // Gradle ë²„ì „ í™•ì¸
                    bat '''
                        echo Gradle í™˜ê²½ í™•ì¸:
                        gradlew.bat --version
                    '''
                    
                    // í”„ë¡œì íŠ¸ ì •ë³´ ì¶œë ¥
                    echo "í”„ë¡œì íŠ¸: ì²­ë…„ë¶€ ëª¨ë°”ì¼ ì£¼ë³´ ì‹œìŠ¤í…œ"
                    echo "ë¹Œë“œ ë²ˆí˜¸: ${BUILD_NUMBER}"
                    echo "ì‘ì—… ê³µê°„: ${WORKSPACE}"
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'Gradle ë¹Œë“œ ì‹œì‘...'
                script {
                    try {
                        // Gradle ë¹Œë“œ ì‹¤í–‰ (Windows í™˜ê²½)
                        bat '''
                            set JAVA_HOME=%JAVA_HOME%
                            gradlew.bat clean build -x test --no-daemon
                        '''
                        echo 'âœ… ë¹Œë“œ ì„±ê³µ!'
                    } catch (Exception e) {
                        echo "âŒ ë¹Œë“œ ì‹¤íŒ¨: ${e.getMessage()}"
                        error "ë¹Œë“œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                    }
                }
            }
            
            post {
                success {
                    echo 'ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë³´ê´€ ì¤‘...'
                    archiveArtifacts artifacts: 'build/libs/*.jar', fingerprint: true
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘...'
                script {
                    try {
                        bat '''
                            set JAVA_HOME=%JAVA_HOME%
                            gradlew.bat test --no-daemon
                        '''
                        echo 'âœ… í…ŒìŠ¤íŠ¸ í†µê³¼!'
                    } catch (Exception e) {
                        echo "âš ï¸ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${e.getMessage()}"
                        // í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œì—ë„ ë°°í¬ëŠ” ê³„ì† ì§„í–‰ (ì„ íƒì‚¬í•­)
                    }
                }
            }
            
            post {
                always {
                    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰
                    script {
                        try {
                            publishTestResults testResultsPattern: 'build/test-results/test/*.xml'
                            publishHTML([
                                allowMissing: false,
                                alwaysLinkToLastBuild: true,
                                keepAll: true,
                                reportDir: 'build/reports/tests/test',
                                reportFiles: 'index.html',
                                reportName: 'Test Report'
                            ])
                        } catch (Exception e) {
                            echo "í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë°œí–‰ ì¤‘ ì˜¤ë¥˜: ${e.getMessage()}"
                        }
                    }
                }
            }
        }
        
        stage('Stop Previous Application') {
            steps {
                echo 'ì´ì „ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€ ì¤‘...'
                script {
                    try {
                        // ì´ì „ ì‹¤í–‰ ì¤‘ì¸ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€
                        bat '''
                            @echo off
                            echo ì´ì „ ì• í”Œë¦¬ì¼€ì´ì…˜ í”„ë¡œì„¸ìŠ¤ í™•ì¸ ë° ì¤‘ì§€...
                            
                            REM Java í”„ë¡œì„¸ìŠ¤ ì¤‘ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì°¾ê¸°
                            for /f "tokens=2" %%i in ('tasklist /fi "imagename eq java.exe" /fo table /nh ^| findstr "java.exe"') do (
                                echo Java í”„ë¡œì„¸ìŠ¤ ID: %%i
                                taskkill /f /pid %%i 2>nul
                            )
                            
                            REM í¬íŠ¸ 80 ì‚¬ìš© ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ í™•ì¸
                            netstat -ano | findstr :80 | findstr LISTENING
                            if %errorlevel% equ 0 (
                                echo í¬íŠ¸ 80ì´ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. í”„ë¡œì„¸ìŠ¤ë¥¼ í™•ì¸í•˜ì„¸ìš”.
                            ) else (
                                echo í¬íŠ¸ 80ì´ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
                            )
                            
                            timeout 3
                        '''
                        echo 'âœ… ì´ì „ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë¦¬ ì™„ë£Œ'
                    } catch (Exception e) {
                        echo "âš ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ (ì •ìƒì ì¼ ìˆ˜ ìˆìŒ): ${e.getMessage()}"
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì¤‘...'
                script {
                    try {
                        // Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰
                        bat '''
                            @echo off
                            echo ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì¤‘...
                            
                            set JAVA_HOME=%JAVA_HOME%
                            set SPRING_PROFILES_ACTIVE=prod
                            
                            REM JAR íŒŒì¼ ì°¾ê¸°
                            for %%f in (build\\libs\\*.jar) do set JAR_FILE=%%f
                            
                            if not defined JAR_FILE (
                                echo ERROR: JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                                exit /b 1
                            )
                            
                            echo JAR íŒŒì¼: %JAR_FILE%
                            echo Java Home: %JAVA_HOME%
                            echo í¬íŠ¸: %DEPLOY_PORT%
                            
                            REM ë°±ê·¸ë¼ìš´ë“œì—ì„œ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
                            start "Youth Bulletin App" /min "%JAVA_HOME%\\bin\\java" -jar -Dserver.port=%DEPLOY_PORT% -Dspring.profiles.active=prod "%JAR_FILE%"
                            
                            echo ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.
                            timeout 10
                        '''
                        
                        echo "âœ… ë°°í¬ ì™„ë£Œ! í¬íŠ¸ ${DEPLOY_PORT}ì—ì„œ ì„œë¹„ìŠ¤ ì¤‘"
                    } catch (Exception e) {
                        echo "âŒ ë°°í¬ ì‹¤íŒ¨: ${e.getMessage()}"
                        error "ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì¤‘...'
                script {
                    def maxRetries = 12
                    def retryCount = 0
                    def healthCheckPassed = false
                    
                    while (retryCount < maxRetries && !healthCheckPassed) {
                        try {
                            sleep(time: 5, unit: 'SECONDS')
                            
                            // PowerShellì„ ì‚¬ìš©í•œ í—¬ìŠ¤ì²´í¬
                            def response = bat(
                                script: """
                                    @echo off
                                    powershell -Command "try { \$response = Invoke-WebRequest -Uri 'http://localhost:${DEPLOY_PORT}/api/bulletin/today' -UseBasicParsing -TimeoutSec 10; if(\$response.StatusCode -eq 200) { exit 0 } else { exit 1 } } catch { exit 1 }"
                                """,
                                returnStatus: true
                            )
                            
                            if (response == 0) {
                                healthCheckPassed = true
                                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ! (ì‹œë„ ${retryCount + 1}/${maxRetries})"
                            } else {
                                retryCount++
                                echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... (ì‹œë„ ${retryCount}/${maxRetries})"
                            }
                        } catch (Exception e) {
                            retryCount++
                            echo "âš ï¸ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: ${e.getMessage()} (ì‹œë„ ${retryCount}/${maxRetries})"
                        }
                    }
                    
                    if (!healthCheckPassed) {
                        error "í—¬ìŠ¤ì²´í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì œëŒ€ë¡œ ì‹œì‘ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                    }
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                echo 'ë¹Œë“œ ì •ë¦¬ ì¤‘...'
                script {
                    try {
                        // ì„ì‹œ íŒŒì¼ ì •ë¦¬
                        bat '''
                            @echo off
                            echo ì„ì‹œ íŒŒì¼ ì •ë¦¬ ì¤‘...
                            if exist "build\\tmp" rmdir /s /q "build\\tmp" 2>nul
                            echo ì •ë¦¬ ì™„ë£Œ
                        '''
                        echo 'âœ… ë¹Œë“œ ì •ë¦¬ ì™„ë£Œ'
                    } catch (Exception e) {
                        echo "âš ï¸ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜: ${e.getMessage()}"
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo 'íŒŒì´í”„ë¼ì¸ ì™„ë£Œ'
        }
        
        success {
            echo """
            ğŸ‰ ë°°í¬ ì„±ê³µ!
            
            ğŸ“± ì ‘ì† ì£¼ì†Œ:
            - ë©”ì¸: http://localhost:${DEPLOY_PORT}/
            - ëª¨ë°”ì¼: http://localhost:${DEPLOY_PORT}/mobile
            - API ë¬¸ì„œ: http://localhost:${DEPLOY_PORT}/swagger-ui.html
            - H2 ì½˜ì†”: http://localhost:${DEPLOY_PORT}/h2-console
            
            ğŸ” ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ í™•ì¸:
            - í”„ë¡œì„¸ìŠ¤: tasklist | findstr java.exe
            - í¬íŠ¸: netstat -ano | findstr :${DEPLOY_PORT}
            
            ğŸ“‹ ìœ ìš©í•œ ëª…ë ¹ì–´:
            - ë¡œê·¸ í™•ì¸: Jenkins ì½˜ì†” ë˜ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ì°½
            - ì¬ì‹œì‘: Jenkinsì—ì„œ "Build Now" ë‹¤ì‹œ ì‹¤í–‰
            """
        }
        
        failure {
            echo """
            âŒ ë°°í¬ ì‹¤íŒ¨!
            
            ğŸ” ë¬¸ì œ í•´ê²°:
            1. Jenkins ì½˜ì†” ë¡œê·¸ í™•ì¸
            2. Java ê²½ë¡œ í™•ì¸: ${JAVA_HOME}
            3. í¬íŠ¸ ì¶©ëŒ í™•ì¸: netstat -ano | findstr :${DEPLOY_PORT}
            4. JAR íŒŒì¼ í™•ì¸: dir build\\libs\\*.jar
            
            ğŸ’¡ ì¼ë°˜ì ì¸ í•´ê²°ì±…:
            - ì´ì „ Java í”„ë¡œì„¸ìŠ¤ ìˆ˜ë™ ì¢…ë£Œ
            - í¬íŠ¸ ë³€ê²½ (application.yml)
            - Java ê²½ë¡œ í™•ì¸ ë° ìˆ˜ì •
            """
        }
        
        unstable {
            echo 'âš ï¸ ë¹Œë“œëŠ” ì„±ê³µí–ˆì§€ë§Œ ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'
        }
    }
}
